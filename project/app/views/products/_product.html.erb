<div class="span-24 left">
	<fieldset>
		<legend>
			Producto
		</legend>
		<%= form_for $product do |f| %>
		<% if $product.errors.any? %>
		<div id="error_explanation">
			<h2>Esta prohibido guardar un producto sin datos correctos:</h2>
			<ul>
				<% $product.errors.full_messages.each do |msg| %>
				<li>
					<%= msg %>
				</li>
				<% end %>
			</ul>
		</div>
		<% end %>
		<ul>
			<li>
			    <label for="retire_note">*Nota Retiro NÂ°:</label>
			    <input id="retire_note" type="text"  value="" size="5" />
			</li>
			<li>
			    <label>Cliente:</label>
			    <input id="customer_id" type="text" style="width: 50%" />
			</li>
			<div class="clear"></div>
			<li>
				<label>Cant Productos:</label>
				<input id='total_id' type="text" size="5" />
			</li>
			<li>
				<label>Fecha:</label>
				<%= f.text_field :created_at, {value: $product.format_admission_date, class:'i_fecha', size: 15, maxlength: 12} %>
			</li>
		</ul>
	</fieldset>
	<fieldset>
		<div class="subtitle">
            <h4>Registrar Producto</h4>
          </div>
		
		<ul>
			<div class="hide"><%= f.hidden_field :retire_note_id, id: 'retire_note_id_hidden' %></div> 
			<li>
				<label>Item:</label>
				<input id='item_id' type="text" size="5" />
			</li> 
			<li>
				<label>Tipo de Producto:</label>
				<input id='product_type' type="text" size="20"/>
				<%= f.hidden_field :product_type_id, id: 'product_type_id_hidden' %>
			</li>
			<div class="clear"></div>
			<li>
				<label>Remitente:</label>
				<%= f.text_field :remitter, id:'remitter_id', value: "" ,style: 'width: 50%' %>
			</li>
			<li>
				<label>*Codigo de Barra:</label>
				<%= f.text_field :bar_code, id: 'bar_code',size: '20'%>
			</li>
			<div class="clear"></div>
			<li>
				<label for="receiver">* Destinatario:</label>
			    <input id="receiver" type="text" size="27" />
				<%= f.hidden_field :receiver_id, id: 'receiver_id_hidden' %>
			</li>
			<li>
				<label>Ciudad:</label>
				<input id="city_id" type="text" size="20" />
			</li>
			<div class="clear"></div>
			<li>
				<label>Direccion:</label>
				<input id='address_id' type="text"  size="30" />
			</li>
			<li>
				<label>Fragil:</label>
				<%= f.select :fragile,["si","no"],id:'fragile_id', size:'5'%>
			</li>
			<div class="clear"></div>
			<li>
				<label>Descripcion:</label>
				<%=f.text_field :description, size:'30',id: 'description_id' %>
			</li>
			<li>
				<label>Estado:</label>
				<%=f.select :product_state_id, $product_state.getProductStates,prompt: "-- Seleccionar--", id:'product_state_id' %>
			</li>
			<div class="clear"></div>
		</ul>
		
	
	</fieldset>
	<div class="span-24 center last" >
		
			<%= f.submit 'Guardar', id: 'button_save_id'%>
			<%= link_to 'Limpiar','#', class: 'limpiar button'%>
			<%= link_to 'Cancelar','../main_page/index' ,class: 'button'%>
	</div>
	<% end %>
	
</div>
<script>
	//focus en el formulario
    $("form:not(.filter) :input:visible:enabled:first").focus();
	$('.limpiar').click(function() {
		$('input[type=text]').val("");
		$('input[type=number]').val("");

	});
	//Aqui se hacer disable todo los imputs que se setean automaticamente
	$("#customer_id").attr({disabled: true});
	$("#total_id").attr({disabled: true});
	$("#item_id").attr({disabled: true});
	$("#product_type").attr({disabled: true});
	$("#city_id").attr({disabled: true});
	$("#address_id").attr({disabled: true});
	//$("#button_save_id").attr({disabled: true});
	
	
	//Autocomplite de notas de retiro
	$(function() {

		var list =[];
		var i=0;
		var item=1;
		<% $retire_notes.each do |r| %>
		 	list[i]={
		 		label: "<%= r.number %>",id: "<%= r.id %>", product_type_id:"<%=r.product_type_id %>", 
		 		amount:<%=r.amount %>, customer_id:"<%=r.customer_id %>" };
			i=i+1;
		<% end %>
		//autocomplete de nota de retiro
		$("#retire_note").autocomplete({
			source: list,
			select: function(event, ui) { 
				$("#retire_note_id_hidden").val(ui.item.id);
				$("#product_type_id_hidden").val(ui.item.product_type_id);
				$("#total_id").val(ui.item.amount);
				
				var product_type_id=ui.item.product_type_id;
				var customer_id=ui.item.customer_id;
				$.amount=ui.item.amount;
				
				
				
				//Metodo ajax que envia el id del tipo de producto al metodo getProducType
				//dentro del controller y como resultado obtiene un objeto product_type
				$.post("<%= getProductType_products_path %>",
				{"id": product_type_id},
				function(product_type){
					$("#product_type").val(product_type.description);
				},"json");
				//Metodo ajax que envia el id del customer al metodo getCustomer
				//dentro del controller y como resultado obtiene un objeto customer
				$.post("<%= getCustomer_products_path %>",
				{"id": customer_id},
				function(customer){
					$("#remitter_id").val(customer.name + " "+ customer.last_name + " " + customer.company_name);
					$("#customer_id").val(customer.name + " "+ customer.last_name + " " + customer.company_name);
				},"json");
				
				//coloco el foco para que ingrese el codigo de barra
				$('#bar_code').focus();
			}
		});
		if($("#retire_note_id_hidden").val()!= "") {
			//Cuando el id de la nota de retiro no es vacio se setea el numero de la nota en el campo
						
			var id=$("#retire_note_id_hidden").val();
			var name= ""
			var product_type_id=-1;
			var customer_id=-1;
			$.amount=-1
			// busca el empleado dentro de la lista
			$(list).each(function(index,element){
				if(element.id == id){
					name=element.label;
					product_type_id=element.product_type_id;
					customer_id=element.customer_id;
					amount=element.amount
					return true
				}
			})
			//setea el nombre del empleado en el campo employee
			$("#retire_note").val(name);
			
			//---------------------------
			
			//se setean las variables
			$("#retire_note_id_hidden").val(id);
			$("#product_type_id_hidden").val(product_type_id);
			$("#total_id").val(amount);
				
				
				
			//ajax product
			$.post("<%= getProductType_products_path %>",
			{"id": product_type_id},
			function(product_type){
				$("#product_type").val(product_type.description);
			},"json");
			//ajax para cliente
			$.post("<%= getCustomer_products_path %>",
			{"id": customer_id},
			function(customer){
				$("#remitter_id").val(customer.name + " "+ customer.last_name + " " + customer.company_name);
				$("#customer_id").val(customer.name + " "+ customer.last_name + " " + customer.company_name);
			},"json");
				
			//coloco el foco para que ingrese el codigo de barra
			$('#bar_code').focus();
			//---------------------------
		}
		
		//Metodo ajax para obtejer el nro de item del servidor
		
		$.post("<%= getItem_products_path %>",{"amount": $.amount},
		function(objectItem){
			$("#item_id").val(objectItem.item);
		},"json");
		
		
	});
	
	//Autocomplite de destinatarios
	$(function() {
		var list =[];
		var i=0;
		<% $receivers.each do |receiver| %>
		 	list[i]={
		 		label: "<%= receiver.receiver_name %>",
		 		id: <%= receiver.id %>, city_id:<%= receiver.city_id %>, address:"<%= receiver.address %>"};
			i=i+1;
		<% end %>
		//receiver autocomplete
		$("#receiver").autocomplete({
			source: list,
			select: function(event, ui) { 
				$("#receiver_id_hidden").val(ui.item.id);
				//se obtiene elid del receiver
				var receiver_id=ui.item.id;
				//llamada ajax tipo Post al metodo setReceiverData para setear el id
				//del receiver, como resultado devuelve un objecto receiver
				$.post("<%= getReceiver_products_path %>",
				{"id": receiver_id},
				function(receiver){
					$("#city_id").val(receiver.city_name); //seteo el nombre de la ciudad en el campo city_id
					$("#address_id").val(receiver.address); //seteo el nombre de la direccion en el camco address_id
					$('#fragile_id').focus();
				},"json");	
			}
		});
		if($("#receiver_id_hidden").val()!= "") {
			//Cuando el id de receiver no es vacio se setea el nombre del receiver en el campo
						
			var id=$("#receiver_id_hidden").val();
			var name= ""
			// busca el empleado dentro de la lista
			$(list).each(function(index,element){
				if(element.id == id){
					name=element.label
					return true
				}
			})
			//setea el nombre del destinatario en el campo receiver
			$("#receiver").val(name);
		}
	});
	
	//Validaciones
	//Validacion del nro de la nota de retiro
	 var f1 = new LiveValidation('retire_note', { validMessage: " ",onlyOnSubmit: true,wait: 500 });
        f1.add( Validate.Numericality, { notANumberMessage: " " } );
        f1.add( Validate.Presence, { failureMessage: " " } );
    //Validacion del codigo de barra
     var f2 = new LiveValidation('bar_code', { validMessage: " ",onlyOnSubmit: true,wait: 500 });
        f2.add( Validate.Numericality, { notANumberMessage: " " } );
        f2.add( Validate.Presence, { failureMessage: " " } );
     //Validacion del receiver
     var f3 = new LiveValidation('receiver', { validMessage: " ",onlyOnSubmit: true,wait: 500 });
        f3.add( Validate.Presence, { failureMessage: " " } );
        
     //Validacion del remitente
	 var f4 = new LiveValidation('remitter', { validMessage: " ",onlyOnSubmit: true,wait: 500 });
        f4.add( Validate.Presence, { failureMessage: " " } );
	
</script>
